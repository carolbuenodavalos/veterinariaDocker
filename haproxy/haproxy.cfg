###############################################################################
# HAProxy - Balanceamento de Carga para Aplicação Veterinária
# Projeto Mensal 4: Conteinerização e Balanceamento de Carga
###############################################################################

global
    log stdout format raw local0 info
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    # Habilita verificação de saúde nos backends
    option  httpchk GET /
    # Retry automático em caso de falha
    retries 3
    option  redispatch

###############################################################################
# Frontend - Ponto de Entrada HTTP
###############################################################################
frontend http_front
    bind *:80
    mode http
    
    # Logs detalhados para debug
    option httplog
    option forwardfor except 127.0.0.1
    
    # Redireciona para HTTPS se for domínio system1 ou system2
    acl is_system1 hdr(host) -i system1.local.projetomensal.com.br
    acl is_system2 hdr(host) -i system2.local.projetomensal.com.br
    
    http-request redirect scheme https code 301 if is_system1 OR is_system2
    
    # Tráfego localhost vai direto para frontend (sem TLS)
    default_backend frontend_servers

###############################################################################
# Frontend - Ponto de Entrada HTTPS
###############################################################################
frontend https_front
    bind *:443 ssl crt /etc/ssl-projetomensal.com.br/haproxy-combined.pem
    mode http
    
    option httplog
    option forwardfor except 127.0.0.1
    
    # Headers de segurança
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options DENY
    http-response set-header Referrer-Policy no-referrer-when-downgrade
    
    # ACLs para roteamento baseado em domínio
    acl is_system1 hdr(host) -i system1.local.projetomensal.com.br
    acl is_system2 hdr(host) -i system2.local.projetomensal.com.br
    
    # ACLs para roteamento de API
    acl is_api path_beg /api/
    acl is_auth path_beg /auth/
    
    # Roteamento de Backend baseado em domínio
    use_backend backend1_servers if is_system1 is_api
    use_backend backend2_servers if is_system2 is_api
    
    # Roteamento de Keycloak
    use_backend keycloak_server if is_auth
    
    # Frontend (SPA Angular) - Balanceamento Round-Robin
    default_backend frontend_servers

###############################################################################
# Backend Pool - Frontend (Angular SPA)
# Algoritmo: Round-Robin (distribui igualmente entre 2 réplicas)
###############################################################################
backend frontend_servers
    mode http
    balance roundrobin
    
    # Verificação de saúde (health check)
    option httpchk GET /
    http-check expect status 200
    
    # Sticky sessions baseado em cookie (mantém usuário no mesmo servidor)
    cookie SERVERID insert indirect nocache
    
    # 2 réplicas do frontend (Nginx + Angular)
    server front-c1 frontend1:80 check cookie front1 fall 3 rise 2 inter 2000ms
    server front-c2 frontend2:80 check cookie front2 fall 3 rise 2 inter 2000ms
    
    # Estatísticas de saúde dos servidores
    stats enable
    stats uri /haproxy?stats
    stats refresh 10s

###############################################################################
# Backend Pool - Backend Sistema 1 (Spring Boot)
# Algoritmo: Round-Robin
###############################################################################
backend backend1_servers
    mode http
    balance roundrobin
    
    # Verificação de saúde
    option httpchk GET /actuator/health
    http-check expect status 200
    
    # Headers necessários para proxy reverso
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    
    # 2 réplicas do backend Sistema 1
    server back1-c1 backend1:8080 check fall 3 rise 2 inter 2000ms
    server back1-c2 backend1_replica:8080 check fall 3 rise 2 inter 2000ms

###############################################################################
# Backend Pool - Backend Sistema 2 (Spring Boot)
# Algoritmo: Round-Robin
###############################################################################
backend backend2_servers
    mode http
    balance roundrobin
    
    # Verificação de saúde
    option httpchk GET /actuator/health
    http-check expect status 200
    
    # Headers necessários
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    
    # 2 réplicas do backend Sistema 2
    server back2-c1 backend2:8080 check fall 3 rise 2 inter 2000ms
    server back2-c2 backend2_replica:8080 check fall 3 rise 2 inter 2000ms

###############################################################################
# Backend - Keycloak (Autenticação)
# Sem balanceamento (instância única)
###############################################################################
backend keycloak_server
    mode http
    balance roundrobin
    
    # Remove o prefixo /auth do path antes de enviar ao Keycloak
    # Exemplo: /auth/realms/veterinaria -> /realms/veterinaria
    http-request replace-path /auth(.*) \1
    
    # Headers necessários para Keycloak
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header X-Forwarded-Port 443 if { ssl_fc }
    
    # Verificação de saúde TCP (não usa endpoint HTTP por questões de compatibilidade)
    option tcp-check
    
    # Instância única do Keycloak com healthcheck TCP
    server keycloak1 keycloak:8080 check fall 3 rise 2 inter 3000ms

###############################################################################
# Estatísticas do HAProxy
# Acesso: http://localhost:8404/stats
###############################################################################
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
    stats auth admin:admin
